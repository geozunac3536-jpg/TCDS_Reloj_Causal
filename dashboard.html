<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reloj Causal Humano — TCDS [Shannon Entropy v1.5]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Nodo sensor TCDS: Medición de entropía espectral de Shannon y coherencia Q-Driven.">
  <style>
    :root {
      --bg: #030413;
      --bg-alt: #0b0f1f;
      --fg: #f5f7ff;
      --accent: #35e0ff;
      --accent2: #ff6bff;
      --accent3: #40ff9c;
      --danger: #ff6b6b;
      --ok: #4ade80;
      --warn: #f97316;
      --card-radius: 20px;
      --shadow-soft: 0 24px 70px rgba(0,0,0,0.85);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      min-height: 100dvh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      color: var(--fg);
      background:
        radial-gradient(circle at top, #202852 0%, #060716 40%, #01010a 100%),
        radial-gradient(circle at 10% 90%, rgba(53,224,255,0.12), transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(255,107,255,0.15), transparent 55%);
    }

    .shell {
      max-width: 1100px;
      margin: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* --- RELOJ PRINCIPAL --- */
    .big-clock {
      background:
        radial-gradient(circle at 50% 20%, rgba(53,224,255,0.18), transparent 60%),
        radial-gradient(circle at center, #02030b 0%, #02020a 55%, #000000 100%);
      border-radius: 32px;
      padding: 24px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      transition: 0.3s border-color, 0.3s box-shadow, 0.3s transform;
      isolation: isolate;
    }

    .big-clock::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 20% 0%, rgba(53,224,255,0.12), transparent 75%),
        radial-gradient(circle at 80% 100%, rgba(255,107,255,0.10), transparent 75%);
      opacity: 0.9;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .big-clock svg {
      width: 100%;
      height: auto;
      display: block;
      position: relative;
      z-index: 1;
    }

    .big-clock {
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
    }

    .big-clock.ready {
      border-color: rgba(56,189,248,0.9);
      box-shadow:
        0 0 35px rgba(56,189,248,0.45),
        0 24px 70px rgba(0,0,0,0.9);
      transform: translateY(-2px);
    }

    .big-clock-glow {
      position: absolute;
      inset: 8%;
      border-radius: 999px;
      background: radial-gradient(circle at center, rgba(53,224,255,0.14), transparent 70%);
      filter: blur(20px);
      opacity: 0.7;
      pointer-events: none;
      z-index: 0;
    }

    /* --- MÓDULO SIGMA / REGLAS --- */
    .sigma-module {
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(53,224,255,0.35);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      text-align: center;
    }

    .rule-box {
      background: radial-gradient(circle at top, rgba(255,255,255,0.12), rgba(15,23,42,0.8));
      border-radius: 10px;
      padding: 8px 4px;
      font-size: 10px;
      color: rgba(241,245,249,0.7);
      transition: 0.18s transform, 0.2s box-shadow, 0.2s border-color, 0.2s background-color, 0.2s color;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 8px 16px rgba(15,23,42,0.7);
    }

    .rule-box strong {
      display: block;
      font-size: 13px;
      margin-bottom: 2px;
      letter-spacing: 0.05em;
    }

    .rule-pass {
      background: radial-gradient(circle at top, rgba(74,222,128,0.22), rgba(15,23,42,0.95));
      border-color: rgba(74,222,128,0.9);
      color: var(--ok);
      box-shadow:
        0 0 10px rgba(74,222,128,0.35),
        0 12px 24px rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }

    .rule-fail {
      background: radial-gradient(circle at top, rgba(248,113,113,0.20), rgba(15,23,42,0.96));
      border-color: rgba(248,113,113,0.95);
      color: var(--danger);
      box-shadow:
        0 0 8px rgba(248,113,113,0.3),
        0 10px 22px rgba(15,23,42,0.95);
      transform: translateY(-0.5px);
    }

    /* --- TARJETAS / LAYOUT --- */
    .card {
      background: linear-gradient(145deg, rgba(15,23,42,0.90), rgba(15,23,42,0.98));
      border-radius: var(--card-radius);
      padding: 14px 16px;
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -20%;
      background:
        radial-gradient(circle at 0% 0%, rgba(53,224,255,0.08), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(255,107,255,0.06), transparent 55%);
      opacity: 0.6;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      opacity: 0.92;
      margin-bottom: 8px;
      letter-spacing: 0.12em;
      color: rgba(226,232,240,0.98);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr);
      gap: 14px;
    }

    @media (max-width: 800px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* --- BOTONES --- */
    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: 0.2s transform, 0.2s box-shadow, 0.2s background-color, 0.2s color, 0.2s opacity;
      box-shadow: 0 8px 22px rgba(15,23,42,0.85);
    }

    #startBtn {
      background: radial-gradient(circle at 30% 0%, #a5f3fc, #0ea5e9);
      color: #020617;
    }

    #startBtn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 14px rgba(56,189,248,0.55),
        0 16px 30px rgba(15,23,42,0.95);
    }

    #stopBtn {
      background: radial-gradient(circle at 30% 0%, #fecaca, #ef4444);
      color: #0b0f19;
      opacity: 0.92;
    }

    #stopBtn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 14px rgba(248,113,113,0.55),
        0 16px 30px rgba(15,23,42,0.95);
      opacity: 1;
    }

    .geo-tag {
      font-size: 10px;
      color: var(--accent);
      margin-top: 4px;
      display: block;
    }

    .metrics-line {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* --- TEXTO PEQUEÑO --- */
    .small-info {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .small-info strong {
      color: var(--accent2);
      font-weight: 600;
    }

    /* --- ANIMACIONES --- */
    @keyframes spin-slow {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse-center {
      0%   { r: 12; opacity: 0.55; }
      50%  { r: 18; opacity: 1; }
      100% { r: 12; opacity: 0.55; }
    }

    @keyframes rotate-led {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes rotate-led-inverse {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }

    @keyframes sweep {
      0% { filter: drop-shadow(0 0 10px rgba(255, 107, 255, 0.5)); }
      50% { filter: drop-shadow(0 0 20px rgba(255, 107, 255, 0.8)); }
      100% { filter: drop-shadow(0 0 10px rgba(255, 107, 255, 0.5)); }
    }

    @keyframes rotate {
      0% { transform: rotate(-60deg); }
      100% { transform: rotate(300deg); }
    }

    #tcNeedle {
      filter: drop-shadow(0 0 5px rgba(53, 224, 255, 0.5));
    }

    #freqNeedle {
      filter: drop-shadow(0 0 10px rgba(255, 107, 255, 0.5));
    }

    footer {
      text-align: center;
      font-size: 10px;
      opacity: 0.60;
      margin-top: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="big-clock" id="bigClock">
      <div class="big-clock-glow"></div>
      <div style="position:absolute; top:18px; right:22px; font-size:11px; color:var(--accent);" id="modeLabel">
        ESPERANDO NODO...
      </div>
      <svg viewBox="0 0 1000 800" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="burbuja" x="-20%" y="-20%" width="140%" height="140%">
            <feGaussianBlur stdDeviation="10" result="blur"/>
            <feComposite in="SourceGraphic" in2="blur" operator="over"/>
          </filter>
          <radialGradient id="gradDial" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#020617"/>
            <stop offset="55%" stop-color="#020617"/>
            <stop offset="100%" stop-color="#000000"/>
          </radialGradient>
          <linearGradient id="gradNeedle" x1="0%" y1="100%" x2="0%" y2="0%">
            <stop offset="0%" stop-color="#35e0ff"/>
            <stop offset="100%" stop-color="#f9fafb"/>
          </linearGradient>
          <radialGradient id="gradRing" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="rgba(56,189,248,0.2)"/>
            <stop offset="50%" stop-color="rgba(56,189,248,0.05)"/>
            <stop offset="100%" stop-color="rgba(148,163,184,0.4)"/>
          </radialGradient>
          <pattern id="clockPattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
            <rect x="0" y="0" width="20" height="20" fill="transparent"/>
            <circle cx="10" cy="10" r="2" fill="#35e0ff" />
          </pattern>
        </defs>

        <!-- Disco principal -->
        <circle cx="500" cy="400" r="380" fill="url(#gradDial)" filter="url(#burbuja)"/>
        <circle cx="500" cy="400" r="365" stroke="url(#gradRing)" stroke-width="2" fill="none" opacity="0.9"/>

        <!-- Halo giratorio -->
        <g transform="translate(500,400)" style="animation: spin-slow 60s linear infinite;">
          <circle r="340" fill="none" stroke="#40FF9C" stroke-width="1.4"
                  stroke-dasharray="16 26" opacity="0.45"/>
        </g>

        <!-- Aguja t_C (Magnitud de aceleración relativa) -->
        <line id="tcNeedle"
              x1="500" y1="400" x2="500" y2="150"
              stroke="url(#gradNeedle)" stroke-width="8"
              stroke-linecap="round"
              transform="rotate(-60 500 400)"/>

        <!-- Aguja de Frecuencia Pico (estructura espectral) -->
        <line id="freqNeedle"
              x1="500" y1="400" x2="500" y2="110"
              stroke="#ff6bff" stroke-width="4"
              opacity="0.9"/>
         
        <!-- Centro y etiqueta -->
        <circle cx="500" cy="400" r="11" fill="#020617" stroke="#35e0ff" stroke-width="2.5"/>
        <circle cx="500" cy="400" r="14" fill="none" stroke="rgba(148,163,184,0.7)" stroke-width="1.2"/>

        <circle cx="500" cy="400" r="15"
                fill="none"
                stroke="rgba(53,224,255,0.7)"
                stroke-width="2"
                style="animation: pulse-center 2.3s ease-in-out infinite;"/>

        <text x="500" y="480"
              fill="#e5e7eb"
              font-size="24"
              text-anchor="middle"
              opacity="0.9"
              style="letter-spacing:0.18em; text-transform:uppercase;">
          t_C
        </text>

        <text x="500" y="510"
              fill="#9ca3af"
              font-size="11"
              text-anchor="middle"
              opacity="0.8">
          (visualización de magnitud de aceleración relativa)
        </text>
      </svg>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title">Módulo de Impacto Sigma (Auditoría TCDS)</div>
        <div class="small-info">
          Auditoría en tiempo real. <strong>Shannon Entropy</strong> mide la distribución espectral de la señal
          y aplica el <strong>Filtro E-Veto</strong>: sólo se considera coherente cuando la entropía cae de forma
          forzada (ΔH &lt; 0) y consistente (ΔH &lt; −0.5).
        </div>

        <div class="sigma-module">
          <div class="rule-box" id="ruleLI">
            <strong>LI ≥ 0.9</strong>
            <span>Locking Index (estabilidad local)</span>
          </div>
          <div class="rule-box" id="ruleR">
            <strong>R &gt; 0.95</strong>
            <span>Kuramoto (proxy de fase)</span>
          </div>
          <div class="rule-box" id="ruleEnt">
            <strong>ΔH &lt; −0.5</strong>
            <span>Shannon (Orden espectral)</span>
          </div>
        </div>

        <div class="metrics-line" style="margin-top:12px;">
          <span id="geoStatus" class="geo-tag">
            GPS: Esperando permisos...
          </span>
          <span id="timeSyncStatus" class="geo-tag" style="color:var(--ok);">
            Reloj: Local (Sync pendiente)
          </span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Métricas y Control del Nodo</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:12px; margin-bottom:12px;">
          <div>|a|: <strong id="magLive">0.00</strong></div>
          <div>LI: <strong id="liLive">0.00</strong></div>
          <div>R: <strong id="rLive">0.00</strong></div>
          <div>ΔH: <strong id="dHLive">0.00</strong></div>
          <div>Factor Q: <strong id="qLive" style="color:var(--accent);">--</strong></div>
          <div>Frec. Pico: <strong id="peakLive">0.00</strong> Hz</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="startBtn">ACTIVAR NODO</button>
          <button id="stopBtn">DETENER</button>
        </div>
      </div>
    </div>

    <footer>
      Nodo Sensor Distribuido TCDS v1.5 — Shannon | Genaro Carrasco Ozuna
    </footer>
  </div>

  <script>
    /* ================= CONFIGURACIÓN TCDS ================= */
    const REPORT_URL = "https://tcds-reloj-causal.vercel.app/api/reports";
    const DEVICE_ID = (crypto.randomUUID ? crypto.randomUUID() : 'anon-' + Math.random());

    /* ================= VARIABLES DE ESTADO ================= */
    let accelBuffer = [];
    let lastTime = 0;

    let current_LI = 0;
    let current_R = 0;
    let current_dH = 0;
    let current_aMag = 0;
    let current_Q = 0;
    let current_PeakFreq = 0;

    let geoData = { lat: null, lon: null, acc: null };
    let timeOffset = 0;
    const N_FFT = 256;

    /* ================= UI REFERENCES ================= */
    const ruleLI = document.getElementById('ruleLI');
    const ruleR = document.getElementById('ruleR');
    const ruleEnt = document.getElementById('ruleEnt');
    const geoStatus = document.getElementById('geoStatus');

    /* ================= LÓGICA DE GEOLOCALIZACIÓN ================= */
    function getGeolocation() {
      if (!navigator.geolocation) {
        geoStatus.textContent = "GPS: No soportado";
        return;
      }
      geoStatus.textContent = "GPS: Solicitando...";
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          geoData.lat = pos.coords.latitude;
          geoData.lon = pos.coords.longitude;
          geoData.acc = pos.coords.accuracy;
          geoStatus.textContent = `GPS: Activo (\( {geoData.lat.toFixed(4)}, \){geoData.lon.toFixed(4)})`;
          geoStatus.style.color = "var(--ok)";
        },
        (err) => {
          console.warn("Error GPS:", err);
          geoStatus.textContent = "GPS: Denegado (Nodo anónimo)";
          geoStatus.style.color = "var(--danger)";
        },
        { enableHighAccuracy: true }
      );
    }

    /* ================= ANÁLISIS ESPECTRAL + SHANNON ================= */
    function computeSpectralSharpness() {
      if (accelBuffer.length < N_FFT) return;

      const slice = accelBuffer.slice(-N_FFT);
      const mean = slice.reduce((a,b) => a + b, 0) / N_FFT;

      let maxMag = 0;
      let peakFreq = 0;
      let spectrum = [];
      let totalSpectralPower = 0;

      // Banda baja 0.2–7 Hz aprox. (primeros 30 bins)
      for (let k = 1; k < 30; k++) {
        let real = 0, imag = 0;
        for (let n = 0; n < N_FFT; n++) {
          const angle = -2 * Math.PI * k * n / N_FFT;
          const val = slice[n] - mean;
          real += val * Math.cos(angle);
          imag += val * Math.sin(angle);
        }
        const mag = Math.sqrt(real * real + imag * imag);
        spectrum.push(mag);
        totalSpectralPower += mag;

        if (mag > maxMag) {
          maxMag = mag;
          peakFreq = k * (60 / N_FFT); // Asunción fs ≈ 60 Hz
        }
      }

      if (maxMag < 0.1) {
        current_Q = 0;
        current_dH = 0; // Silencio ≈ entropía máxima (sin estructura útil)
        return;
      }

      // Factor Q: nitidez de pico
      const halfPower = maxMag * 0.5;
      let widthBins = 0;
      spectrum.forEach(mag => { if (mag > halfPower) widthBins++; });
      current_Q = widthBins > 0 ? (1.0 / widthBins) : 0;
      current_PeakFreq = peakFreq;

      // Entropía de Shannon normalizada
      let shannonH = 0;
      if (totalSpectralPower > 0) {
        for (let mag of spectrum) {
          const p = mag / totalSpectralPower;
          if (p > 0) {
            shannonH += -p * Math.log2(p);
          }
        }
      }

      const maxH = Math.log2(spectrum.length || 1);
      const normalizedH = maxH > 0 ? shannonH / maxH : 1;
      // mapeo a ΔH ∈ [−1, 0]
      current_dH = normalizedH - 1.0;

      // UI espectral
      document.getElementById('qLive').textContent = current_Q.toFixed(2);
      document.getElementById('peakLive').textContent = current_PeakFreq.toFixed(1);

      const freqAngle = -150 + (Math.min(peakFreq / 10, 1) * 300);
      document.getElementById('freqNeedle')
        .setAttribute('transform', `rotate(${freqAngle} 500 400)`);
    }

    /* ================= SINCRONIZACIÓN ================= */
    async function syncTime() {
      try {
        timeOffset = 0;
        document.getElementById('timeSyncStatus').textContent =
          "Reloj: Sincronizado (Local)";
      } catch (e) {
        console.warn("Sync time error", e);
      }
    }

    /* ================= FUSIÓN DE MÉTRICAS TCDS ================= */
    function updateMetrics() {
      if (accelBuffer.length < 32) return;

      const slice = accelBuffer.slice(-64);
      const mean = slice.reduce((a,b) => a + b, 0) / slice.length;
      const variance = slice.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / slice.length;
      const std = Math.sqrt(variance);

      // LI: estabilidad de amplitud (menor ruido → mayor LI)
      const noiseNorm = Math.min(std / 4, 1);
      let raw_LI = 1.0 - noiseNorm;

      // Inyección de Q: si el espectro es nítido, aumenta confianza
      current_LI = (raw_LI * 0.6) + (current_Q * 0.4);

      // R proxy: acoplado a LI (futura versión podría usar fases reales)
      current_R = 0.8 + (0.2 * current_LI);

      // Reglas visuales (E-Veto y locking)
      if (current_LI >= 0.9) {
        ruleLI.className = "rule-box rule-pass";
      } else {
        ruleLI.className = "rule-box rule-fail";
      }

      if (current_R > 0.95) {
        ruleR.className = "rule-box rule-pass";
      } else {
        ruleR.className = "rule-box rule-fail";
      }

      if (current_dH < -0.5) {
        ruleEnt.className = "rule-box rule-pass";
      } else {
        ruleEnt.className = "rule-box rule-fail";
      }

      // UI numérica
      document.getElementById('liLive').textContent = current_LI.toFixed(2);
      document.getElementById('rLive').textContent = current_R.toFixed(2);
      document.getElementById('dHLive').textContent = current_dH.toFixed(3);

      // Telemetría: sólo cuando LI alto + entropía baja (doble sello)
      if (current_LI > 0.85 && current_dH < -0.4) {
        sendReport();
      }
    }

    /* ================= ENVÍO DE REPORTE ================= */
    function sendReport() {
      const now = Date.now();
      if (window.lastReport && (now - window.lastReport < 5000)) return;
      window.lastReport = now;

      const payload = {
        device_id: DEVICE_ID,
        timestamp: now + timeOffset,
        geo: geoData,
        metrics: {
          aMag: current_aMag,
          LI: current_LI,
          R: current_R,
          dH: current_dH,
          Q_Arnold: current_Q
        }
      };

      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });

      if (navigator.sendBeacon) {
        navigator.sendBeacon(REPORT_URL, blob);
      } else {
        fetch(REPORT_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' }
        }).catch(() => {});
      }
    }

    /* ================= HANDLERS DE SENSORES ================= */
    function handleMotion(e) {
      const a = e.accelerationIncludingGravity;
      if (!a) return;

      const mag = Math.hypot(a.x || 0, a.y || 0, a.z || 0);

      accelBuffer.push(mag);
      if (accelBuffer.length > 512) accelBuffer.shift();
      current_aMag = mag;

      // t_C visual: desviación respecto a 9.8 m/s²
      const normalizedMag = Math.abs(mag - 9.8);
      const tcAngle = -60 + (Math.min(normalizedMag / 5, 1) * 120);
      document.getElementById('tcNeedle')
        .setAttribute('transform', `rotate(${tcAngle} 500 400)`);
      document.getElementById('magLive').textContent = mag.toFixed(2);

      // Lanzar análisis espectral aproximadamente cada ~100 ms
      if (Date.now() % 100 < 20) {
        computeSpectralSharpness();
      }

      updateMetrics();
    }

    async function init() {
      getGeolocation();
      syncTime();

      if (typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceMotionEvent.requestPermission();
          if (permission !== 'granted') {
            alert("Se requiere permiso de acelerómetro para el Reloj Causal.");
            return;
          }
        } catch (e) {
          console.error(e);
        }
      }

      window.addEventListener('devicemotion', handleMotion);
      document.getElementById('bigClock').classList.add('ready');
      document.getElementById('modeLabel').textContent = "NODO ACTIVO (SHANNON)";
    }

    document.getElementById('startBtn').onclick = init;
    document.getElementById('stopBtn').onclick = () => {
      window.removeEventListener('devicemotion', handleMotion);
      document.getElementById('bigClock').classList.remove('ready');
      document.getElementById('modeLabel').textContent = "DETENIDO";
    };
  </script>
</body>
</html>
